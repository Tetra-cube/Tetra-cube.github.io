<link rel='stylesheet' type='text/css' href='QuoteGenStyle.css'>
<!DOCTYPE html>
<html>
<title>Quote Generator</title>
<body background="Images/pagebackground.png">
	<canvas id='imageCanvas'></canvas><br><br>
	<form id='optionsForm'>
		<div id='normalOptions'>
			<div id='lpOptions'>
				<img src='Images/remove.png' id='lpremove' title='Remove Portrait' />
				Left Portrait: <input type='file' id='lp' />
				Flip<input type='checkbox' id='lpflip' />
				Sprite Index: <input type='number' id='lpindex' min='1' value='1' disabled /><br>
			</div>
			<div id='rpOptions'>
				<img src='Images/remove.png' id='rpremove' title='Remove Portrait' />
				Right Portrait: <input type='file' id='rp' />
				Flip<input type='checkbox' id='rpflip' />
				Sprite Index: <input type='number' id='rpindex' min='1' value='1' disabled /><br>
			</div>
			<div id='nameOption'>
				Name: <input type='text' id='name' /><br>
			</div>
			<div id='dialogueOption1'>
				Line 1: <input type='text' id='dialogue1' /><br>
			</div>
			<div id='dialogueOption2'>
				Line 2: <input type='text' id='dialogue2' /><br>
			</div>
			<div id='boxLocationOption'>
				Left<input type='radio' name='boxLocation' id='lBoxRadio'>
				Right<input type='radio' name='boxLocation' id='rBoxRadio'>
				No Textbox<input type='radio' name='boxLocation' id='noBoxRadio'>
			<br>
			</div>
		</div>
		<br><br><br><br>
		<div id='advancedOptions'>
			Additional Options:<br><br>
			<div id='bkgOptions'>
				<img src='Images/remove.png' id='removebkg' title='Restore Default Background' />
				Background Image: <input type='file' id='bkg' /><br>
			</div>
			<div id='lp2Options'>
				<img src='Images/remove.png' id='lp2remove' title='Remove Portrait' />
				Left Portrait 2: <input type='file' id='lp2' />
				Flip<input type='checkbox' id='lp2flip' />
				Sprite Index: <input type='number' id='lp2index' min='1' value='1' disabled /><br>
			</div>
			<div id='rp2Options'>
				<img src='Images/remove.png' id='rp2remove' title='Remove Portrait' />
				Right Portrait 2: <input type='file' id='rp2' />
				Flip<input type='checkbox' id='rp2flip' />
				Sprite Index: <input type='number' id='rp2index' min='1' value='1' disabled /><br>
			</div>
			<div id='boxTypeOption'>
				Box Type 1<input type='radio' name='boxType' id='type1Radio'>
				Box Type 2<input type='radio' name='boxType' id='type2Radio'>
				Box Type 3<input type='radio' name='boxType' id='type3Radio'>
				Box Type 4<input type='radio' name='boxType' id='type4Radio'>
				Box Type 5<input type='radio' name='boxType' id='type5Radio'>
			<br>
			<div id='darkenPortraitOptions'>
				Darken:
				Left<input type='checkbox' id='lpdarken' />
				Right<input type='checkbox' id='rpdarken' />
				Left 2<input type='checkbox' id='lp2darken' />
				Right 2<input type='checkbox' id='rp2darken' />
			</div>
			<div id='darkenBkgOption'>
				Add Black Bars to Background <input type='checkbox' id='darkenBkg' />
			</div>
		</div>
	</form>
</body>
<footer>
  <br><br><br><br>By <a href="http://chickenwraith.tumblr.com/">Chickenwraith</a> | Resources from <a href="http://incorrectfeaquotes.tumblr.com/tagged/resources">here</a> | <a href="https://github.com/Tetra-cube/Tetra-cube.github.io">GitHub repository</a> | Version 1.3
</footer>

<script>
const lp=0, rp=1, lp2=2, rp2=3, bkgnum=4, drk=5, canvasWidth=400, canvasHeight=240, spriteWidth=256, spriteHeight=256, spriteOff=28, spriteOff2=-28, darkenConst=0.25;
var offset = [0, canvasWidth-spriteWidth, 0, canvasWidth-spriteWidth];			// for drawing sprites
var flipOffset = [-spriteWidth, -canvasWidth, -spriteWidth, -canvasWidth];		// for drawing flipped sprites
var bkg = document.getElementById('bkg');
var canvas = document.getElementById('imageCanvas');
var charName = document.getElementById('name');
var dialogue1 = document.getElementById('dialogue1');
var dialogue2 = document.getElementById('dialogue2');
var darkenBkg = document.getElementById('darkenBkg');
var ctx = canvas.getContext('2d');
var reader = new FileReader();
var uploaded = [false, false, false, false, false];
var portraits = [], flipBoxes = [], darkBoxes = [], removeButtons = [], ssIndices = [];
portraits[lp] = document.getElementById('lp');						// get uploading buttons
portraits[rp] = document.getElementById('rp');
portraits[lp2] = document.getElementById('lp2');
portraits[rp2] = document.getElementById('rp2');
flipBoxes[lp] = document.getElementById('lpflip');					// get flip checkboxes
flipBoxes[rp] = document.getElementById('rpflip');
flipBoxes[lp2] = document.getElementById('lp2flip');
flipBoxes[rp2] = document.getElementById('rp2flip');
darkBoxes[lp] = document.getElementById('lpdarken');					// get darken checkboxes
darkBoxes[rp] = document.getElementById('rpdarken');
darkBoxes[lp2] = document.getElementById('lp2darken');
darkBoxes[rp2] = document.getElementById('rp2darken');
removeButtons[lp] = document.getElementById('lpremove');				// get remove image buttons
removeButtons[rp] = document.getElementById('rpremove');
removeButtons[lp2] = document.getElementById('lp2remove');
removeButtons[rp2] = document.getElementById('rp2remove');
ssIndices[lp] = document.getElementById('lpindex');					// get index fields for spritesheets
ssIndices[rp] = document.getElementById('rpindex');
ssIndices[lp2] = document.getElementById('lp2index');
ssIndices[rp2] = document.getElementById('rp2index');
// set code for options
for(var a = 0; a < 4; a++){
	portraits[a].addEventListener('change',(function(num){
		return function(e){
			uploaded[num] = true;
			reader.onload = function(event){images[num].src = event.target.result;}
			reader.readAsDataURL(e.target.files[0]);
			removeButtons[num].style.display = 'inline';
			ssIndices[num].value = '1';
			ssIndices[num].removeAttribute('disabled');
		}
	})(a),false);
	flipBoxes[a].addEventListener('click',reloadCanvas,false);
	darkBoxes[a].addEventListener('click',reloadCanvas,false);
	removeButtons[a].style.display = 'none';
	removeButtons[a].addEventListener('click',(function(num){
		return function(){
			uploaded[num] = false;
			removeButtons[num].style.display = 'none';
			reloadCanvas();
			portraits[num].value = '';
			flipBoxes[num].checked = false;
			ssIndices[num].value = '1';
			ssIndices[num].disabled = true;
		}
	})(a),false);
	ssIndices[a].addEventListener('change',reloadCanvas,false);
	// reset to defaults
	portraits[a].value = '';
	flipBoxes[a].checked = false;
	darkBoxes[a].checked = false;
	ssIndices[a].value = '1';
	ssIndices[a].disabled = true;
}
// code for canvas
var images = [];
for(var a = 0; a < 6; a++){
	images[a] = new Image();
	images[a].addEventListener('load',reloadCanvas,false);
}
bkg.addEventListener('change',function(e){
		reader.onload = function(event){images[bkgnum].src = event.target.result;}
		reader.readAsDataURL(e.target.files[0]);
		removebkg.style.display = 'inline';
	},false);
removebkg.addEventListener('click',function(){
		images[bkgnum].src = 'Images/defaultbkg.png';
		removebkg.style.display = 'none';
		reloadCanvas();
		bkg.value = '';
	},false);
charName.addEventListener('change',reloadCanvas,false);
dialogue1.addEventListener('change',reloadCanvas,false);
dialogue2.addEventListener('change',reloadCanvas,false);
darkenBkg.addEventListener('click',reloadCanvas,false);
canvas.width = canvasWidth;
canvas.height = canvasHeight;
// for dialogue
var textBoxImages = [], textBoxRadioButtons = [], textBoxTypeRadioButtons = [];
var namePlate,talkCursor,textBoxType=0;
textBoxRadioButtons[0] = document.getElementById('lBoxRadio');
textBoxRadioButtons[1] = document.getElementById('rBoxRadio');
textBoxRadioButtons[2] = document.getElementById('noBoxRadio');
for(var a = 0; a < 3; a++){
	textBoxImages[a] = new Image();
}
textBoxRadioButtons[0].addEventListener('click',function(){
	darkBoxes[0].checked = false;
	darkBoxes[1].checked = true;
	darkBoxes[2].checked = true;
	darkBoxes[3].checked = true;
	reloadCanvas();
	},false);
textBoxRadioButtons[1].addEventListener('click',function(){
	darkBoxes[0].checked = true;
	darkBoxes[1].checked = false;
	darkBoxes[2].checked = true;
	darkBoxes[3].checked = true;
	reloadCanvas();
	},false);
textBoxRadioButtons[2].addEventListener('click',function(){
	darkBoxes[0].checked = false;
	darkBoxes[1].checked = false;
	darkBoxes[2].checked = false;
	darkBoxes[3].checked = false;
	reloadCanvas();
	},false);
textBoxTypeRadioButtons[0] = document.getElementById('type1Radio');
textBoxTypeRadioButtons[1] = document.getElementById('type2Radio');
textBoxTypeRadioButtons[2] = document.getElementById('type3Radio');
textBoxTypeRadioButtons[3] = document.getElementById('type4Radio');
textBoxTypeRadioButtons[4] = document.getElementById('type5Radio');
for(var a = 0; a < 11; a++){
	textBoxImages[a] = new Image();
}
for(var a = 0; a < 5; a++){
	textBoxTypeRadioButtons[a].checked=false;
	textBoxTypeRadioButtons[a].addEventListener('click',(function(num){
		return function(){
			textBoxType = num;
			reloadCanvas();
		}
	})(a),false);
}
ctx.font = '15px "Chiaro"';
textBoxTypeRadioButtons[0].checked=true;
textBoxImages[0].src = 'Images/tboxC.png';
textBoxImages[1].src = 'Images/tbox1L.png';
textBoxImages[2].src = 'Images/tbox1R.png';
textBoxImages[3].src = 'Images/tbox2L.png';
textBoxImages[4].src = 'Images/tbox2R.png';
textBoxImages[5].src = 'Images/tbox3L.png';
textBoxImages[6].src = 'Images/tbox3R.png';
textBoxImages[7].src = 'Images/tbox4L.png';
textBoxImages[8].src = 'Images/tbox4R.png';
textBoxImages[9].src = 'Images/tbox5L.png';
textBoxImages[10].src = 'Images/tbox5R.png';
nameplate = new Image();
nameplate.src='Images/nameplate.png';
talkCursor = new Image();
talkCursor.src='Images/talkCursor.png';
// for shading
var offscreenCanvas = document.createElement('canvas');
var offscreenCtx = offscreenCanvas.getContext('2d');
offscreenCanvas.width = canvasWidth;
offscreenCanvas.height = canvasHeight;
images[drk].src = 'Images/darken.png';
// reset to defaults
bkg.value = '';
charName.value = '';
dialogue1.value = '';
dialogue2.value = '';
darkenBkg.checked = true;
removebkg.style.display = 'none';
textBoxRadioButtons[0].checked = false;
textBoxRadioButtons[1].checked = false;
textBoxRadioButtons[2].checked = true;

// functions to redraw the canvas when something is changed
function reloadCanvas(){
	ctx.drawImage(images[bkgnum],0,0,canvasWidth,canvasHeight);
	if(darkenBkg.checked)
		ctx.drawImage(images[drk],0,0,canvasWidth,canvasHeight);
	drawImage(lp2);
	drawImage(rp2);
	drawImage(lp);
	drawImage(rp);
	drawTextBox();
}
function drawImage(num){
	if(!uploaded[num])
		return;
	var image=images[num];
	var x;
	var scale;
	var index;
	if(flipBoxes[num].checked){
		scale=-1;
		x = flipOffset[num];
	}
	else{
		scale=1;
		x = offset[num];
	}
	x+=getSpriteOff(num,scale)
	index = ssIndices[num].value-1;
	var sswidth = Math.floor(image.width/spriteWidth);
	var sx = index%sswidth;
	var sy = Math.floor(index/sswidth);
	ctx.save();
	ctx.scale(scale,1);
	ctx.drawImage(image,sx*spriteWidth,sy*spriteHeight,spriteWidth,spriteHeight,x,0,spriteWidth,spriteHeight);
	if(darkBoxes[num].checked)
		darkenImage(image,x,sx,sy,num,scale)
	drawTextBox();
	ctx.restore();
}
function darkenImage(image,x,sx,sy,num,scale){
	offscreenCtx.clearRect(0,0,offscreenCanvas.width,offscreenCanvas.height);
	offscreenCtx.save();
	offscreenCtx.scale(scale,1);
	var offX;
	if(scale==-1)
		offX=-spriteWidth;
	else
		offX=0;
    offscreenCtx.drawImage(image,sx*spriteWidth,sy*spriteHeight,spriteWidth,spriteHeight,x,0,spriteWidth,spriteHeight);
	// get pixels from canvas & offscreen canvas
	var imageData = ctx.getImageData(0,0,canvasWidth,canvasHeight);
	var pixels = imageData.data;
	var offscreenImageData = offscreenCtx.getImageData(0,0,canvasWidth,canvasHeight);
	var offscreenPixels = offscreenImageData.data;
	// set pixels
	for(var i = 0; i < pixels.length; i += 4) {
	   var alpha = offscreenPixels[i+3] * darkenConst / 255;
	   pixels[i] -= offscreenPixels[i] * alpha;
	   pixels[i+1] -= offscreenPixels[i+1] * alpha;
	   pixels[i+2] -= offscreenPixels[i+2] * alpha;
	}
	// overlay the shaded image on the canvas
	ctx.putImageData(imageData,0,0);
	offscreenCtx.restore();
}
const leftx=-27,topy=146;
var leftOffArray=[0,4,8,12,16];
var widthMax=[12,12,11,11,10];
function drawTextBox(){
	var type=textBoxType*2+1;
	var leftOff=leftx+leftOffArray[textBoxType];
	if(!(textBoxRadioButtons[0].checked || textBoxRadioButtons[1].checked))
		return;
	var alignLeft=textBoxRadioButtons[0].checked;
	var edgeWidth=textBoxImages[type].width+textBoxImages[type+1].width;
	var textBoxWidth = Math.floor((Math.max(ctx.measureText(dialogue1.value).width,ctx.measureText(dialogue2.value).width)
						-edgeWidth+140-leftOffArray[textBoxType]*2)/textBoxImages[0].width);
	if(textBoxWidth<1)
		textBoxWidth=1;
	else if(textBoxWidth>widthMax[textBoxType])
		textBoxWidth=widthMax[textBoxType];
	var centerWidth=textBoxImages[0].width*textBoxWidth;
	var drawx;
	if(alignLeft)
		drawx=leftOff;
	else
		drawx=canvasWidth-leftOff-edgeWidth-centerWidth;
	ctx.drawImage(textBoxImages[type],drawx,topy);
	drawx+=textBoxImages[type].width;
	for(var a = 0; a < textBoxWidth; a++){
		ctx.drawImage(textBoxImages[0],drawx,topy)
		drawx+=textBoxImages[0].width;
	}
	ctx.drawImage(textBoxImages[type+1],drawx,topy);
	ctx.drawImage(talkCursor,drawx+leftOff+78,216);
	ctx.fillStyle = '#4e3d29';
	ctx.textAlign = 'left';
	if(alignLeft){
		textX=leftx+57;
		nameplateX=leftOff+126
	}
	else{
		textX=canvasWidth-leftx-71-114-centerWidth-leftOffArray[textBoxType]*2;
		nameplateX=canvasWidth-leftOff-126;
	}
	ctx.fillText(dialogue1.value,textX,202);
	ctx.fillText(dialogue2.value,textX,224);
	ctx.drawImage(nameplate,nameplateX-63,161);
	ctx.fillStyle = 'white';
	ctx.textAlign = 'center';
	ctx.fillText(charName.value,nameplateX,178);
}
function getSpriteOff(num,scale){
	switch(num){
		case lp:
			return -spriteOff*scale;
		case rp:
			return spriteOff*scale;
		case lp2:
			return -spriteOff2*scale;
		case rp2:
			return spriteOff2*scale;
	}
	return 0;
}
// set the default background
images[bkgnum].src = 'Images/defaultbkg.png';
</script>